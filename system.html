<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" href="favicon.png" sizes="any" type="image/x-icon">
	<link rel="stylesheet" href="system.css">
	<link rel="stylesheet" href="bootstrap.min.css" media="print" onload="this.media='all'">
	<link rel="stylesheet" href="all.min.css" media="all" onload="this.media='all'">
	<link rel="stylesheet" href="util.css">
	<link rel="stylesheet" href="side-bar.css">
	<link rel="stylesheet" href="top-bar.css">
	<title>WS2C - System Settings</title>
</head>

<header>
	<div id="top-bar"></div>
	<div id="side-bar"></div>
</header>

<body> 

	<div id="loading" class="hidden loading_screen">
		<h1 data-I18N="restarting">Restarting...</h1>
	</div>
	
	<div class="div-main">
	
		<div class="alert alert-warning hidden" id="div-error" role="alert">
			<p id="invalid_auth" data-I18N="invalid_auth" class="hidden"></p>
			<p id="invalid_ap" data-I18N="invalid_ap" class="hidden"></p>
			<p id="invalid_sta" data-I18N="invalid_sta" class="hidden"></p>
			<p id="invalid_sta_ssid_empty" data-I18N="invalid_sta_ssid_empty" class="hidden"></p>
			<p id="invalid_space" data-I18N="invalid_space" class="hidden"></p>
			<p id="invalid_ip" data-I18N="invalid_ip" class="hidden"></p>
		</div>
		
		<div class="alert alert-success hidden" id="div-success" role="alert">
			<p id="success-system" data-I18N="success_msg">
				The data has been stored successfully. </br>
				The board needs to restart for the configurations to take place. </br>
				You can click <a onclick="loading_screen()" href="/restart">HERE</a> 
				to restart now or restart manually later.
			</p>
		</div>
	
		<div class="page-title">
			<h5 data-I18N="system_l"> System Settings </h3>
		</div>
	
		<form method="POST" id="form-post">
		
			<div class="card card-system">
				<div class="card-header">
					<h4 data-I18N="auth">Authentication</h4>
				</div>
				<div class="card-body">
					<div class="auth-username card-input">
						<span class="input-span" data-I18N="username">Username</span>
						<input class="form-control" type="text" name="username" id="username" data-I18N="username" placeholder="Username">
					</div>
					<div class="auth-pswd card-input">
						<span class="input-span" data-I18N="password">Password</span>
						<input class="form-control" type="password" name="password" id="password" data-I18N="password" placeholder="Password">
					</div>
				</div>
			</div>
			
			<div class="card card-system">
				<div class="card-header">
					<h4 data-I18N="lan">LAN Settings</h4>
					<p id="dhcp_ip"></p>
				</div>
				<div class="card-body">
					<div id="lan-info">
						<div class="card-input">
							<span class="input-span" data-I18N="lan_ip">LAN IP</span>
							<input class="form-control" type="text" name="lanip" id="lanip" data-I18N="lan_ip" placeholder="LAN IP">
						</div>
						<div class="card-input">
							<span class="input-span" data-I18N="subnet_mask">Subnet Mask</span>
							<input class="form-control" type="text" name="netmask" id="netmask" data-I18N="subnet_mask" placeholder="Subnet Mask">
						</div>
						<div class="card-input">
							<span class="input-span" data-I18N="gateway">Gateway</span>
							<input class="form-control" type="text" name="gateway" id="gateway" data-I18N="gateway" placeholder="Gateway">
						</div>
						<div class="card-input">
							<span class="input-span" data-I18N="dns">DNS</span>
							<input class="form-control" type="text" name="dns" id="dns" data-I18N="dns" placeholder="DNS">
						</div>
					</div>
					<div class="card-input input-checkbox">
						<p>DHCP:</p>
						<input type="checkbox" name="dhcp" id="dhcp">
					</div>
				</div>
			</div>
			
			<div class="card card-system">
				<div class="card-header">
					<h4 data-I18N="wifi">WiFi Settings</h4>
				</div>
				<div class="card-body">
					<div class="card-input input-checkbox">
						<span class="input-span" data-I18N="wifi_mode">WiFi Mode</span>
						<select class="form-control" id="options-wifi-mode" name="wifi-mode">
							<option value="1">AP</option>
							<option value="2">STA</option>
							<option value="3" select>AP + STA</option>
						</select>
					</div>
					<div class="card-input">
						<span class="input-span" data-I18N="ap_ssid">AP SSID</span>
						<input class="form-control" type="text" name="apssid" id="apssid" data-I18N="ap_ssid" placeholder="AP SSID">
					</div>
					<div class="card-input">
						<span class="input-span" data-I18N="ap_key">AP Key</span>
						<input class="form-control" type="password" name="apkey" id="apkey" data-I18N="ap_key" placeholder="AP Key">
					</div>
					<div class="card-input">
						<span class="input-span" data-I18N="ap_channel">AP Channel</span>
						<select class="form-control" id="options-ap-channel" name="ap-channel">
							<option value="0" select>AUTO</option>
							<option value="1">CH1</option>
							<option value="2">CH2</option>
							<option value="3">CH3</option>
							<option value="4">CH4</option>
							<option value="5">CH5</option>
							<option value="6">CH6</option>
							<option value="7">CH7</option>
							<option value="8">CH8</option>
							<option value="9">CH9</option>
							<option value="10">CH10</option>
							<option value="11">CH11</option>
							<option value="12">CH12</option>
							<option value="13">CH13</option>
						</select>
					</div>
					<div class="card-input">
						<span class="input-span" data-I18N="sta_ssid">STA SSID</span>
						<div class="input-ssid">
							<input class="form-control" type="text" name="stassid" id="stassid" data-I18N="sta_ssid" placeholder="STA SSID">
							<button class="btn btn-primary btn-scan-ssid" id="btn-scan-ssid" type="button" onclick="scanSSID()" data-I18N="scan">SCAN</button>
							<div class="spinner-border text-primary hidden" id="spinner-ssid" role="status"></div>
						</div>
						<div class="div-list-ssid hidden" id="div-list-ssid">
							<span class="input-span" data-I18N="sta_scanned">Scanned</span>
							<select class="form-control list-ssid" id="list-ssid" onchange="setSSID()"></select>
						</div>
					</div>
					<div class="card-input">
						<span class="input-span" data-I18N="sta_key">STA Key</span>
						<input class="form-control" type="password" name="stakey" id="stakey" data-I18N="sta_key" placeholder="STA Key">
					</div>
				</div>
			</div>
			
			<div class="div-btn-save">
				<button class="btn btn-primary btn-save" id="btn-save-system" data-I18N="save" 
				type="submit" onclick="spinner_by('spinner', 'btn-save-system', 1)">
					Save
				</button>
				<div class="spinner-border text-primary hidden" id="spinner" role="status"></div>
			</div>
			
		</form>
	</div>
	

</body>

<script src="scripts.js"></script>
<script>

	async function loadData(error) {
		const response = await fetch(error ? '/get-data-error' : '/get-data-system');
		const data = await response.json();

		const fieldMap = {
			username: "username", password: "password", dhcp: "dhcp", lan_ip: "lanip",
			subnet_mask: "netmask", gateway: "gateway", dns: "dns", wifi_mode: "options-wifi-mode",
			apssid: "apssid", apkey: "apkey", ap_channel: "options-ap-channel",
			stassid: "stassid", stakey: "stakey", dhcp_ip: "dhcp_ip"
		};

		for (const [key, elementId] of Object.entries(fieldMap)) {
			const element = document.getElementById(elementId);

			if (element) {
				if (key === "dhcp") {
					var dhcp_value = data[key] === "on";
					element.checked = dhcp_value;
					const lanInfo = document.getElementById("lan-info");
					const dhcp_ip = document.getElementById("dhcp_ip");
					if (dhcp_value == 1) {
						lanInfo.classList.add("hidden");
						dhcp_ip.classList.remove("hidden");
					}
					else {
						lanInfo.classList.remove("hidden");
						dhcp_ip.classList.add("hidden");
					}
				} 
				else if (key === "dhcp_ip") {
					element.textContent = "LAN IP: " + data[key];
				}
				else {
					element.value = data[key] || "";
				}
			}
		}
	}

	async function scanSSID() {

		spinner_by("spinner-ssid", "btn-scan-ssid", 1);

		var list_ssid = document.getElementById("list-ssid");
		var div_ssid = document.getElementById("div-list-ssid");

		list_ssid.innerHTML = "";
		div_ssid.classList.add("hidden");

		const response = await fetch('/get-ssid-list');
		const data = await response.json();

		data.ssid_list.forEach(ssid => {
			let option = new Option(ssid, ssid);
    		list_ssid.add(option);
		});

		div_ssid.classList.remove("remove");
		spinner_by("spinner-ssid", "btn-scan-ssid", 0);
	}

	function setSSID() {
		var ssid_input = document.getElementById("stassid");
		var list_ssid = document.getElementById("list-ssid");

		ssid_input.value = list_ssid.value;
	}
	
	document.addEventListener("DOMContentLoaded", () => {

		const dhcp = document.getElementById("dhcp");
		const lanInfo = document.getElementById("lan-info");
		const dhcp_ip = document.getElementById("dhcp_ip");

		let url = new URL(window.location.href);
		let param = url.searchParams.get("error");
		let param2 = url.searchParams.get("success");
		
		var error = param !== null
		var success = param2 !== null;
		
		var div = document.getElementById("div-error");
		var text = document.getElementById(param);
		if (error) {
			div.classList.remove("hidden");

			//Adicionando estilo para elementos dinâmicos
			var is_dinamic = false;
			const list_dinamic = ["invalid_space_", "invalid_ip_"];
			for (i = 0; i < list_dinamic.length; i++){
				if (param.indexOf(list_dinamic[i]) !== -1){
					is_dinamic = true;
					break;
				}
			}

			if (is_dinamic) {
				var index = param.lastIndexOf("_");
				var sub = param.substring(index + 1);

				var input = document.getElementById(sub);
				input.style.border = "1px solid #dc3545"

				document.getElementById(param.substring(0, index)).classList.remove("hidden");
			}
			else {
				text.classList.remove("hidden"); //Se não for elemento dinâmico, libera o elemento estático mencionado.
			}

			//Adicionando estilo para elementos estáticos
			if (param == "invalid_sta_ssid_empty") {
				input.style.border = "1px solid #dc3545";
			}
		}
		
		loadExternal();
		loadData(error);	
		
		var div = document.getElementById("div-success");
		if (success) {
			if (param2 == "true") {
				div.classList.remove("hidden");
			}
		}
		else {
			div.classList.add("hidden");
		}

		dhcp.addEventListener("change", ()=>{
			if (dhcp.checked) {
				lanInfo.classList.add("hidden");
				dhcp_ip.classList.remove("hidden");
				dhcp.value = "on";
			}
			else {
				lanInfo.classList.remove("hidden");
				dhcp_ip.classList.add("hidden");
				dhcp.value = "";
			}
		});
		
	});

</script>

</html>