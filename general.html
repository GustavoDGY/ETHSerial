<!DOCTYPE html>
<html lang="pt-br">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" href="favicon.ico" sizes="any" type="image/x-icon">
	<link rel="stylesheet" href="general.css">
	<link rel="stylesheet" href="bootstrap.min.css" media="print" onload="this.media='all'">
	<link rel="stylesheet" href="all.min.css" media="all" onload="this.media='all'">
	<link rel="stylesheet" href="util.css">
	<link rel="stylesheet" href="side-bar.css">
	<link rel="stylesheet" href="top-bar.css">
	<title>SerialETH - General</title>
</head>

<header>
	<div id="top-bar"></div>
	<div id="side-bar"></div>
</header>

<body> 

	<div id="loading" class="hidden loading_screen">
		<h1>Restarting...</h1>
	</div>
	
	<div class="div-main">
	
		<div class="alert alert-warning hidden" id="div-error" role="alert">
			<p id="error-general"></p>
		</div>
		
		<div class="alert alert-success hidden" id="div-success" role="alert">
			<p id="success-system">
				The data has been stored successfully. </br>
				The board needs to restart for the configurations to take place. </br>
				You can click <a onclick="loading_screen()" href="/restart">HERE</a> 
				to restart now or restart manually later.
			</p>
		</div>
	
		<div class="page-title">
			<h5> General </h3>
		</div>
	
		<form method="POST" id="form-post">
		
			<div class="card card-system">
				<div class="card-header">
					<h4>Options</h4>
				</div>
				<div class="card-body">
                    <div class="card-input input-checkbox">
						<p>Auto Update:</p>
						<input type="checkbox" name="autoupdate" id="autoupdate">
					</div>
                    <div class="card-input input-force-update" id="input-force-update">
                        <a href="/force-update">
						    <button class="btn btn-primary btn-force-update" id="btn-force-update" 
                            type="button" onclick="loading_screen()">
                                <span><i class="fa fa-cloud-download-alt"></i></span> Force Update
                            </button>
                        </a>
                    </div>
					<div class="card-input input-restart">
                        <a href="/restart">
						    <button class="btn btn-primary btn-restart" id="btn-restart" 
                            type="button" onclick="loading_screen()">
                                <span><i class="fa fa-refresh"></i></span> Restart
                            </button>
                        </a>
					</div>
				</div>
			</div>
			
			<div class="div-btn-save">
				<button class="btn btn-primary btn-save" id="btn-save-system" type="submit">Save</button>
			</div>
			
		</form>
	</div>
	

</body>

<script>

	function loading_screen(){
		document.body.style.overflow = "hidden";
		var loading_div = document.getElementById("loading");
		loading.classList.remove("hidden");
	}

	function startSideBar() {
		var btn = document.getElementById("btn-mobile");
		const sideBar = document.getElementById("side-bar")
		btn.addEventListener("click", ()=>{
			sideBar.classList.toggle("hidden");
		});
		
		window.addEventListener("resize", ()=>{
			if (window.innerWidth >= 876) {
				sideBar.classList.remove("hidden");
			}
			else {
				sideBar.classList.add("hidden");
			}
		});

		if (window.innerWidth < 876) {
			sideBar.classList.add("hidden");
		}
	}

	async function loadExternal(){
	
		const sideBar = await fetch("side-bar.html");
		const sideBarContent = await sideBar.text();
		
		const topBar = await fetch("top-bar.html");
		const topBarContent = await topBar.text();
		
		document.getElementById("side-bar").innerHTML = sideBarContent;
		document.getElementById("top-bar").innerHTML = topBarContent;

		startSideBar();
	}

	async function loadData(error) {
		const response = await fetch(error ? '/get-data-error' : '/get-data-general');
		const data = await response.json();

		const fieldMap = {
			autoupdate: "autoupdate",
		};

		for (const [key, elementId] of Object.entries(fieldMap)) {
			const element = document.getElementById(elementId);

            if (key === "autoupdate") {
                var autoUpdate_value = data[key] === "on"
                element.checked = autoUpdate_value;
                var forceUpdateDiv = document.getElementById("input-force-update");
                if (autoUpdate_value){
                    forceUpdateDiv.classList.add("hidden");
                }
                else {
                    forceUpdateDiv.classList.remove("hidden");
                }
            }
			if (element) {
				element.value = data[key] || "";
			}
		}
	}
	
	document.addEventListener("DOMContentLoaded", () => {

		let url = new URL(window.location.href);
		let param = url.searchParams.get("error");
		let param2 = url.searchParams.get("success");
		
		var error = param !== null
		var success = param2 !== null;
		
		var div = document.getElementById("div-error");
		var text = document.getElementById("error-general");
		if (error) {
			div.classList.remove("hidden");
			if (param == "invalid_auth") {
				text.innerHTML = "<p>User and password must be 5 characters or higher</p>";
			}
		}
		else {
			div.classList.add("hidden");
		}
		
		loadExternal();
		loadData(error);	
		
		var div = document.getElementById("div-success");
		if (success) {
			if (param2 == "true") {
				div.classList.remove("hidden");
			}
		}
		else {
			div.classList.add("hidden");
		}

        var autoUpdate = document.getElementById("autoupdate");
        var forceUpdateDiv = document.getElementById("input-force-update");
        autoUpdate.addEventListener("change", ()=>{
            if (autoUpdate.checked){
                autoUpdate.value = "on";
                forceUpdateDiv.classList.add("hidden");
            }
            else {
                autoUpdate.value = "";
                forceUpdateDiv.classList.remove("hidden");
            }
        })
	});


</script>

</html>